version: "3.9"

services:
  # =============================
  # ðŸ§  Auth Frontend (ë¡œê·¸ì¸/íšŒì›)
  # =============================
  auth-frontend:
    build:
      context: ./auth-frontend
      dockerfile: Dockerfile
    container_name: auth-frontend
    ports:
      - "8180:80"  # ðŸ”¸ ë³€ê²½: devì—ì„œëŠ” 5173, ìš´ì˜ì—ì„œëŠ” nginx ë‚´ë¶€ 80í¬íŠ¸ë§Œ ì‚¬ìš©
    environment:
      # ðŸ”¸ ë³€ê²½: ë‚´ë¶€ ì„œë¹„ìŠ¤ URL â†’ ì™¸ë¶€ HTTPS ê¸°ë°˜
      VITE_API_AUTH_BASE_URL: https://emoforge.dev/api/auth
      VITE_API_ATTACH_BASE_URL: https://emoforge.dev/api/attach
      VITE_APP_AUTH_URL: https://emoforge.dev
      VITE_APP_DIARY_URL: https://emoforge.dev/diary
      # ðŸ—‘ï¸ ì œê±°: VITE_APP_POST_URL (post-frontend ì œê±°ë¡œ ë¶ˆí•„ìš”)
    networks:
      - emoforge-net

  # =============================
  # ðŸŒ¿ Diary Frontend (ê°ì •ì¼ê¸°)
  # =============================
  diary-frontend:
    build:
      context: ./diary-frontend
      dockerfile: Dockerfile
    container_name: diary-frontend
    ports:
      - "8181:80"  # ðŸ”¸ ë³€ê²½: devì—ì„œëŠ” 5175, ìš´ì˜ì—ì„œëŠ” ë‚´ë¶€ nginxë¡œ í†µí•© ê°€ëŠ¥
    environment:
      # ðŸ”¸ ë³€ê²½: ë‚´ë¶€ ë„ì»¤ ë„¤íŠ¸ì›Œí¬ ì£¼ì†Œ â†’ HTTPS ì™¸ë¶€ ì£¼ì†Œ
      VITE_API_DIARY_BASE_URL: https://emoforge.dev/api/diary
      VITE_API_AUTH_BASE_URL: https://emoforge.dev/api/auth
      VITE_API_ATTACH_BASE_URL: https://emoforge.dev/api/attach
      VITE_API_LANGGRAPH_BASE_URL: https://emoforge.dev/api/langgraph
      VITE_APP_DIARY_URL: https://emoforge.dev/diary
      VITE_APP_AUTH_URL: https://emoforge.dev
      # ðŸ—‘ï¸ ì œê±°: VITE_APP_POST_URL (post-frontend ì œê±°ë¡œ ë¶ˆí•„ìš”)
    networks:
      - emoforge-net

  # =============================
  # ðŸ› ï¸ Admin Frontend (ê´€ë¦¬ìž)
  # =============================
  admin-frontend:
    build:
      context: ./admin-frontend
      dockerfile: Dockerfile
    container_name: admin-frontend
    ports:
      - "8182:80"  # ðŸ”¸ ë³€ê²½: devì—ì„œëŠ” 5176, ìš´ì˜ nginx ë‚´ë¶€ í¬íŠ¸ë¡œ í†µì¼
    environment:
      VITE_API_AUTH_BASE_URL: https://emoforge.dev/api/auth
      VITE_APP_ADMIN_URL: https://emoforge.dev/admin
      VITE_APP_AUTH_URL: https://emoforge.dev
    networks:
      - emoforge-net

  # =============================
  # ðŸŒ Nginx (ì •ì  íŒŒì¼ ì„œë¹™ + HTTPS ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ)
  # =============================
  nginx:
    image: nginx:alpine
    container_name: nginx_frontend_gateway
    restart: always  # âœ… ì¶”ê°€
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d  # ðŸ”¸ ë³€ê²½: ìš´ì˜ìš© nginx ì„¤ì • íŒŒì¼ ê²½ë¡œ
      - /home/ec2-user/emoforge/certbot/www:/var/www/certbot  # âœ… ì¶”ê°€: certbotìš© ì›¹ ë£¨íŠ¸
      - /home/ec2-user/emoforge/certbot/conf:/etc/letsencrypt  # âœ… ì¶”ê°€: ì¸ì¦ì„œ ì €ìž¥ì†Œ
      # âœ… ì¶”ê°€: ì •ì  íŒŒì¼ ë§¤í•‘ (ë¹Œë“œ ê²°ê³¼ë¬¼ nginxë¡œ ì „ë‹¬)
      - ./auth-frontend/dist:/usr/share/nginx/html/auth
      - ./diary-frontend/dist:/usr/share/nginx/html/diary
      - ./admin-frontend/dist:/usr/share/nginx/html/admin
    depends_on:
      - auth-frontend
      - diary-frontend
      - admin-frontend
    networks:
      - emoforge-net

  # =============================
  # ðŸ” Certbot (Let's Encrypt ìžë™ ê°±ì‹ )
  # =============================
  certbot:
    image: certbot/certbot
    container_name: certbot_frontend
    volumes:
      - /home/ec2-user/emoforge/certbot/conf:/etc/letsencrypt
      - /home/ec2-user/emoforge/certbot/www:/var/www/certbot
    entrypoint: >
      sh -c "trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done"
    networks:
      - emoforge-net

networks:
  emoforge-net:
    external: true
