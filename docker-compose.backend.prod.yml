version: "3.9"

services:
  # =============================
  # ğŸ§  Auth Service
  # =============================
  auth-service:
    build:
      context: ./auth-service
      dockerfile: Dockerfile
    container_name: auth-service
    env_file:
      - ./auth-service/.env.prod   # âœ… ì´ ê²½ë¡œì—ì„œ í™˜ê²½ë³€ìˆ˜ ì½ìŒ
    ports:
      - "8081:8081"
    environment:
      SPRING_PROFILES_ACTIVE: prod

      # âœ… DB ì ‘ì† ì •ë³´ (AWS RDS)
      SPRING_DATASOURCE_URL: jdbc:mysql://emotion-diary-db.cnq2y8k4ebta.ap-northeast-2.rds.amazonaws.com:3306/nfe_auth_db?useSSL=false&serverTimezone=Asia/Seoul
      SPRING_DATASOURCE_USERNAME: ${DB_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}

      # âœ… JWT ì‹œí¬ë¦¿ í‚¤
      JWT_SECRET_USER: ${JWT_SECRET_USER}
      JWT_SECRET_ADMIN: ${JWT_SECRET_ADMIN}

      # âœ… OAuth2 Kakao
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_KAKAO_CLIENT_ID: ${KAKAO_CLIENT_ID}
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_KAKAO_REDIRECT_URI: ${KAKAO_REDIRECT_URI}

      # âœ… reCAPTCHA
      RECAPTCHA_SITE_KEY: ${RECAPTCHA_SITE_KEY}
      RECAPTCHA_SECRET_KEY: ${RECAPTCHA_SECRET_KEY}
      RECAPTCHA_ENABLED: "false"

      # âœ… attachment-service ë‚´ë¶€ URL (ë³€ê²½ ì—†ìŒ)
      SERVICE_ATTACH_URL: http://attachment-service:8082

      # âœ… ë¡œê·¸ ë ˆë²¨
      LOGGING_LEVEL_ROOT: INFO
      LOGGING_LEVEL_DEV_EMOFORGE_AUTH: DEBUG

    networks:
      - emoforge-net

  # =============================
  # ğŸ“ Attachment Service
  # =============================
  attachment-service:
    build:
      context: ./attachment-service
      dockerfile: Dockerfile
    container_name: attachment-service
    env_file:
      - ./attachment-service/.env.prod   # âœ… ì´ ê²½ë¡œì—ì„œ í™˜ê²½ë³€ìˆ˜ ì½ìŒ
    ports:
      - "8082:8082"
    environment:
      SPRING_PROFILES_ACTIVE: prod

      # âœ… DB ì ‘ì† ì •ë³´ (AWS RDS)
      SPRING_DATASOURCE_URL: jdbc:mysql://emotion-diary-db.cnq2y8k4ebta.ap-northeast-2.rds.amazonaws.com:3306/nfe_file_db?useSSL=false&serverTimezone=Asia/Seoul
      SPRING_DATASOURCE_USERNAME: ${DB_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}

      # âœ… JWT Secret
      JWT_SECRET: ${JWT_SECRET_USER}

      # âœ… íŒŒì¼ ì—…ë¡œë“œ ê²½ë¡œ (EC2ìš©ìœ¼ë¡œ ìˆ˜ì •)
      FILE_UPLOAD_PATH_EDITOR_IMAGES_BASE_DIR: /home/ec2-user/emoforge/uploads/editor_images/
      FILE_UPLOAD_PATH_EDITOR_IMAGES_PUBLIC_URL: /uploads/images/
      FILE_UPLOAD_PATH_ATTACHMENTS: /home/ec2-user/emoforge/uploads/attachment/
      FILE_UPLOAD_PATH_PROFILE_IMAGE_BASE_DIR: /home/ec2-user/emoforge/uploads/profile_image/
      FILE_UPLOAD_PATH_PROFILE_IMAGE_PUBLIC_URL: /uploads/profile_image/

    # ğŸ”¸ ë³€ê²½: ë¡œì»¬ C:\ ê²½ë¡œ ì œê±° â†’ EC2 ë‚´ë¶€ ë””ë ‰í† ë¦¬ ì‚¬ìš©
    volumes:
      - /home/ec2-user/emoforge/uploads:/home/ec2-user/emoforge/uploads  # ğŸ”¸ ë³€ê²½ (EC2 ê²½ë¡œë¡œ ìˆ˜ì •)
      

    networks:
      - emoforge-net

  # =============================
  # ğŸŒ¿ Diary Service
  # =============================
  diary-service:
    build:
      context: ./diary-service
      dockerfile: Dockerfile
    container_name: diary-service
    env_file:
      - ./diary-service/.env.prod   # âœ… ì´ ê²½ë¡œì—ì„œ í™˜ê²½ë³€ìˆ˜ ì½ìŒ
    ports:
      - "8084:8084"
    environment:
      SPRING_PROFILES_ACTIVE: prod

      # âœ… DB ì ‘ì† ì •ë³´ (AWS RDS)
      SPRING_DATASOURCE_URL: jdbc:mysql://emotion-diary-db.cnq2y8k4ebta.ap-northeast-2.rds.amazonaws.com:3306/nfe_diary_db?useSSL=false&serverTimezone=Asia/Seoul
      SPRING_DATASOURCE_USERNAME: ${DB_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}

      # âœ… JWT Secret
      JWT_SECRET: ${JWT_SECRET_USER}

      # âœ… OpenAI API Key
      OPENAI_API_KEY: ${OPENAI_API_KEY}

      # âœ… LangGraph ì—°ë™ (ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ ìœ ì§€)
      LANGGRAPH_BASE_URL: http://langgraph_service:8000/api/langgraph
      LANGGRAPH_API_KEY: ${LANGGRAPH_API_KEY}

    depends_on:
      - langgraph_service
      - auth-service
    networks:
      - emoforge-net

  # =============================
  # ğŸ¤– LangGraph (FastAPI)
  # =============================
  langgraph_service:
    build:
      context: ./langgraph_service
      dockerfile: Dockerfile
    container_name: langgraph_service
    env_file:
      - ./langgraph_service/.env.prod
    ports:
      - "8000:8000"
    environment:
      APP_ENV: prod  # ğŸ”¸ ë³€ê²½ (dev â†’ prod)
      APP_NAME: langgraph_Service (Prod)
      APP_HOST: 0.0.0.0
      APP_PORT: 8000
      BASE_URL: http://langgraph_service:8000/api/langgraph

      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_MODEL: gpt-4o-mini

      JWT_SECRET: ${JWT_SECRET_USER}
      JWT_ALGORITHM: HS256
      API_KEY: ${LANGGRAPH_API_KEY}

      YOUTUBE_API_KEY: ${YOUTUBE_API_KEY}
      YOUTUBE_BASE_URL: https://www.googleapis.com/youtube/v3
      YOUTUBE_WATCH_URL: https://www.youtube.com/watch
      YOUTUBE_MUSIC_URL: https://music.youtube.com

      # ğŸ”¸ ë³€ê²½: ìš´ì˜ìš© ë„ë©”ì¸ë§Œ í—ˆìš©
      CORS_ALLOW_ORIGINS: >-
        ["https://emoforge.dev", "https://www.emoforge.dev"]

      LOG_LEVEL: INFO  # ğŸ”¸ ë³€ê²½ (DEBUG â†’ INFO)
      LOG_FILE: logs/langgraph_prod.log  # ğŸ”¸ ë³€ê²½ (prod ë¡œê·¸ ë¶„ë¦¬)

    # âœ… ë¡œê·¸ ë³´ì¡´ ê²½ë¡œ
    volumes:
      - /home/ec2-user/emoforge/logs/langgraph:/app/logs  # ğŸ”¸ ë³€ê²½ (EC2 ì ˆëŒ€ê²½ë¡œ)

    networks:
      - emoforge-net

  # =============================
  # ğŸŒ Nginx Gateway + Certbot
  # =============================
  nginx:
    image: nginx:alpine
    container_name: nginx_gateway
    restart: always  # âœ… ì¶”ê°€
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d
      - /home/ec2-user/emoforge/auth-frontend/dist:/usr/share/nginx/html/auth
      - /home/ec2-user/emoforge/diary-frontend/dist:/usr/share/nginx/html/diary
      - /home/ec2-user/emoforge/admin-frontend/dist:/usr/share/nginx/html/admin
      - /home/ec2-user/emoforge/certbot/www:/var/www/certbot
      - /home/ec2-user/emoforge/certbot/conf:/etc/letsencrypt
    depends_on:
      - auth-service
      - diary-service
      - attachment-service
    networks:
      - emoforge-net

  certbot:
    image: certbot/certbot
    container_name: certbot
    volumes:
      - /home/ec2-user/emoforge/certbot/conf:/etc/letsencrypt
      - /home/ec2-user/emoforge/certbot/www:/var/www/certbot
    entrypoint: >  # âœ… ì¶”ê°€ (ì¸ì¦ì„œ ìë™ ë°œê¸‰ìš©)
      sh -c "trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done"
    networks:
      - emoforge-net

networks:
  emoforge-net:
    external: true
